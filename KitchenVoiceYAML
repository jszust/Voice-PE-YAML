substitutions:
  name: home-assistant-voice-09cf9e
  friendly_name: Kitchen Voice
packages:
  Nabu Casa.Home Assistant Voice PE: github://esphome/home-assistant-voice-pe/home-assistant-voice.yaml
esphome:
  name: ${name}
  name_add_mac_suffix: false
  friendly_name: ${friendly_name}
  on_boot:
    priority: -10
    then:
      - switch.turn_off: timer_ringing
api:
  encryption:
    key: De8PbFewi6Qir6upSUbNWY8kIaI3S75y9RP3vK3K2Ak=
web_server:
  port: 80
  include_internal: true

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

sensor:
  - platform: template
    id: timer_count
    name: "Timers Count"
    accuracy_decimals: 0

  - platform: template
    id: timer_1_seconds_left
    name: "Timer 1 Seconds Left"
    unit_of_measurement: "s"
    accuracy_decimals: 0
    update_interval: 1s
    lambda: |-
      if (id(is_timer_active)) {
        id(fetch_first_active_timer).execute();
        return id(first_active_timer).seconds_left;
      } else {
        return 0;
      }

  - platform: template
    id: timer_2_seconds_left
    name: "Timer 2 Seconds Left"
    unit_of_measurement: "s"
    accuracy_decimals: 0
    update_interval: 1s
    lambda: |-
      const auto &timer_id = id(timer_2_id).state;
      const auto &timer_map = id(va).get_timers();
      
      if (id(is_timer_active) && !timer_id.empty() && timer_map.count(timer_id)) {
        const auto &timer = timer_map.at(timer_id);
        return timer.seconds_left;
      } else {
        return 0;
      }

  - platform: template
    id: timer_3_seconds_left
    name: "Timer 3 Seconds Left"
    unit_of_measurement: "s"
    accuracy_decimals: 0
    update_interval: 1s
    lambda: |-
      const auto &timer_id = id(timer_3_id).state;
      const auto &timer_map = id(va).get_timers();
      
      if (id(is_timer_active) && !timer_id.empty() && timer_map.count(timer_id)) {
        const auto &timer = timer_map.at(timer_id);
        return timer.seconds_left;
      } else {
        return 0;
      }

  - platform: template
    id: timer_1_total_seconds
    name: "Timer 1 Total Seconds"
    unit_of_measurement: "s"
    accuracy_decimals: 0

  - platform: template
    id: timer_2_total_seconds
    name: "Timer 2 Total Seconds"
    unit_of_measurement: "s"
    accuracy_decimals: 0

  - platform: template
    id: timer_3_total_seconds
    name: "Timer 3 Total Seconds"
    unit_of_measurement: "s"
    accuracy_decimals: 0

text_sensor:
  - platform: template
    id: timer_1_id
    name: "Timer 1 ID"
  - platform: template
    id: timer_1_name
    name: "Timer 1 Name"
  - platform: template
    id: timer_1_state
    name: "Timer 1 State"
  - platform: template
    id: timer_2_id
    name: "Timer 2 ID"
  - platform: template
    id: timer_2_name
    name: "Timer 2 Name"
  - platform: template
    id: timer_2_state
    name: "Timer 2 State"
  - platform: template
    id: timer_3_id
    name: "Timer 3 ID"
  - platform: template
    id: timer_3_name
    name: "Timer 3 Name"
  - platform: template
    id: timer_3_state
    name: "Timer 3 State"

script:
  - id: publish_sorted_timers
    then:
      - lambda: |-
          const auto &timer_map = id(va).get_timers();
          id(timer_count).publish_state(timer_map.size());

          //local sorted timer vector


          // Local sorted timer vector
          std::vector<esphome::voice_assistant::Timer> timers;
          timers.reserve(timer_map.size());
          for (const auto &p : timer_map)
            timers.push_back(p.second);

          std::sort(timers.begin(), timers.end(),
                    [](const auto &a, const auto &b) { return a.seconds_left < b.seconds_left; });

          std::array<esphome::template_::TemplateTextSensor*, 3> timer_names = {id(timer_1_name), id(timer_2_name), id(timer_3_name)};
          std::array<esphome::template_::TemplateTextSensor*, 3> timer_ids = {id(timer_1_id), id(timer_2_id), id(timer_3_id)};
          std::array<esphome::template_::TemplateSensor*, 3> timer_seconds = {id(timer_1_total_seconds), id(timer_2_total_seconds), id(timer_3_total_seconds)};
          std::array<esphome::template_::TemplateTextSensor*, 3> timer_states = {id(timer_1_state), id(timer_2_state), id(timer_3_state)};
          
          // clear all slots first
          for (size_t i = 0; i < 3; i++) {
            timer_seconds[i]->publish_state(0);
            timer_names[i]->publish_state("-");
            timer_ids[i]->publish_state("-");
            timer_states[i]->publish_state("idle");
          }

          //If no timers active, done
          if(!id(is_timer_active)) {
            return;
          }

          //For loop to iterate on ordered timer state arrays
          for (size_t i = 0; i < timers.size() && i < 3; i++) {
            const auto &t = timers[i];
            timer_seconds[i]->publish_state(t.total_seconds);
            timer_names[i]->publish_state(t.name);
            timer_ids[i]->publish_state(t.id);
            timer_states[i]->publish_state("active");
          }

voice_assistant:

  # Call the helper lambda on all timer events
  on_timer_started:
    - lambda: |-
        id(check_if_timers_active).execute();
        id(publish_sorted_timers).execute();

  on_timer_finished:
    - delay: 500ms
    - lambda: |-
        id(check_if_timers_active).execute();
        id(publish_sorted_timers).execute();

  on_timer_cancelled:
    - delay: 500ms
    - lambda: |-
        id(check_if_timers_active).execute();
        id(publish_sorted_timers).execute();

  on_timer_updated:
    - delay: 500ms
    - lambda: |-
        id(check_if_timers_active).execute();
        id(publish_sorted_timers).execute();
